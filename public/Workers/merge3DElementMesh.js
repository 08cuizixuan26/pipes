define(function(){"use strict";function c(n,r){return null!=n?n:r}function f(n){return null!=n}var a;function m(n,r,e,t){return h(n).then(r,e,t)}function h(n){var r,e,n=n instanceof l?n:t(n)?(r=d(),n.then(function(n){r.resolve(n)},function(n){r.reject(n)},function(n){r.progress(n)}),r.promise):(e=n,new l(function(n){try{return h(n?n(e):e)}catch(n){return p(n)}}));return n}function l(n){this.then=n}function p(e){return new l(function(n,r){try{return r?h(r(e)):p(e)}catch(n){return p(n)}})}function d(){var n=new l(u),i=[],c=[],t=function(r,e,t){var u=d(),o="function"==typeof t?function(n){try{u.progress(t(n))}catch(n){u.progress(n)}}:function(n){u.progress(n)};return i.push(function(n){n.then(r,e).then(u.resolve,u.reject,o)}),c.push(o),u.promise},r=function(n){return v(c,n),n},e=function(n){return n=h(n),t=n.then,e=h,r=j,v(i,n),c=i=a,n};return{then:u,resolve:o,reject:f,progress:s,promise:n,resolver:{resolve:o,reject:f,progress:s}};function u(n,r,e){return t(n,r,e)}function o(n){return e(n)}function f(n){return e(p(n))}function s(n){return r(n)}}function t(n){return n&&"function"==typeof n.then}function u(n,p,v,g,y){return m(n,function(n){var r,e,t,u,o=n.length>>>0,i=Math.max(0,Math.min(p,o)),c=[],f=o-i+1,s=[],a=d();if(i)for(t=a.progress,e=function(n){s.push(n),--f||(r=e=j,a.reject(s))},r=function(n){c.push(n),--i||(r=e=j,a.resolve(c))},u=0;u<o;++u)u in n&&m(n[u],l,h,t);else a.resolve(c);return a.then(v,g,y);function h(n){e(n)}function l(n){r(n)}})}function e(n,r,e,t){return o(n,i).then(r,e,t)}function o(n,c){return m(n,function(n){var r,e,t,u=r=n.length>>>0,o=[],i=d();if(u)for(e=function(n,r){m(n,c).then(function(n){o[r]=n,--u||i.resolve(o)},i.reject)},t=0;t<r;t++)t in n?e(n[t],t):--u;else i.resolve(o);return i.promise})}function v(n,r){for(var e,t=0;e=n[t++];)e(r)}function j(){}function i(n){return n}c.EMPTY_OBJECT=Object.freeze({}),m.defer=d,m.resolve=h,m.reject=function(n){return m(n,p)},m.join=function(){return o(arguments,i)},m.all=e,m.map=o,m.reduce=function(n,o){var r=g.call(arguments,1);return m(n,function(n){var u=n.length;return r[0]=function(n,e,t){return m(n,function(r){return m(e,function(n){return o(r,n,t,u)})})},y.apply(n,r)})},m.any=function(n,r,e,t){return u(n,1,function(n){return r?r(n[0]):n[0]},e,t)},m.some=u,m.chain=function(n,r,e){var t=2<arguments.length;return m(n,function(n){return r.resolve(n=t?e:n),n},function(n){return r.reject(n),p(n)},r.progress)},m.isPromise=t,l.prototype={always:function(n,r){return this.then(n,n,r)},otherwise:function(n){return this.then(a,n)},yield:function(n){return this.then(function(){return n})},spread:function(r){return this.then(function(n){return e(n,function(n){return r.apply(a,n)})})}};var r,s,g=[].slice,y=[].reduce||function(n){var r,e=0,t=Object(this),u=t.length>>>0,o=arguments;if(o.length<=1)for(;;){if(e in t){r=t[e++];break}if(++e>=u)throw new TypeError}else r=o[1];for(;e<u;++e)e in t&&(r=n(r,t[e],e,t));return r};return r=function(n){n.square},function(n){var u=n.data,o=[],i={id:u.id,result:void 0,error:void 0};return m(function(n,r,e){try{return n(r,e)}catch(n){return m.reject(n)}}(r,u.parameters,o)).then(function(n){i.result=n}).otherwise(function(n){n instanceof Error?i.error={name:n.name,message:n.message,stack:n.stack}:i.error=n}).always(function(){f(s)||(s=c(self.webkitPostMessage,self.postMessage)),u.canTransferArrayBuffer||(o.length=0);try{s(i,o)}catch(n){i.result=void 0,i.error="postMessage failed with error: "+(e=(r=n).name,t=r.message,t=f(e)&&f(t)?e+": "+t:r.toString(),f(r=r.stack)&&(t+="\n"+r),t)+"\n    with responseMessage: "+JSON.stringify(i),s(i)}var r,e,t})}});
