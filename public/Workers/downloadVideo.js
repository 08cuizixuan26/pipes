function downloadVideo(){var e;this.ws=void 0,this.decoder=void 0,this.recieve_count=0,this.return_status=3,SipDecoderEx.runtimeInitialized()?this.decoder=new SipDecoderEx:(e=this,SipDecoderEx.callBack.push(function(){e.decoder=new SipDecoderEx})),this.connect_timeout_event=void 0,this.accept_data_timeout_event=void 0,this.get_response_timeout_event=void 0,this.keep_alive=!1,this.keep_process_data_time_out=!1,this.keep_process_data=!0}function get_current_date(){var e=new Date;return e.getDate()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()}self.importScripts("SipDecoderEx.js"),downloadVideo.prototype.initWebsocket=function(e,t){var i;this.return_status=3,null==this.ws&&(this.deviceid=e.device_id,this.web_url=e.ws_url,this.link_type=e.link_type,this.is_active=e.is_active,this.is_histroy=e.is_history,this.time=e.history_time,this.ws=new WebSocket(this.web_url),this.ws.binaryType="arraybuffer",this.time_out=e.time_out,this.keep_process_data=!0,this.keep_process_data_time_out=!1,this.recieve_max_times=e.recieve_max_times,this.get_main_thread_response_time_out=e.get_main_thread_response_time_out,(i=this).ws.onopen=function(e){var t=get_current_date();console.log("Ws connected."+i.deviceid+" time "+t),i.clear_connect_timeout_event();t=i.deviceid;t+=":",t+=i.link_type,t+=":",t+=i.is_active,t+=":",t+=i.is_histroy,t+=":",t+=i.time,this.send(t),i.accept_data_timeout_event=setInterval(function(){i.accept_data_timeout()},i.time_out),i.get_response_timeout_event=setInterval(function(){i.get_respond_timeout()},i.get_main_thread_response_time_out)},this.ws.onerror=function(e){var t=get_current_date();console.log("WebSocket error happen "+i.deviceid+" time "+t)},this.ws.onclose=function(e){i.recieve_count=0,i.clear_accept_timeout_event(),i.clear_connect_timeout_event(),i.clear_get_respond_timeout_event(),i.ws=void 0;var t,o=i.return_status;3==i.return_status?(t=get_current_date(),console.log("websocket closed width error code"+e.code+" device id "+i.deviceid+" time "+t)):(t=get_current_date(),console.log("normal closed "+i.deviceid+" time "+t),i.return_status=3),i.postMessage({status:o})},this.ws.onmessage=t,this.connect_timeout_event=setTimeout(function(){i.connect_timeout()},this.time_out))},downloadVideo.prototype.clear_connect_timeout_event=function(){null!=this.connect_timeout_event&&(clearTimeout(this.connect_timeout_event),this.connect_timeout_event=void 0)},downloadVideo.prototype.clear_accept_timeout_event=function(){null!=this.accept_data_timeout_event&&(clearTimeout(this.accept_data_timeout_event),this.accept_data_timeout_event=void 0)},downloadVideo.prototype.connect_timeout=function(){console.log("websocket connect_timeout "),this.close()},downloadVideo.prototype.accept_data_timeout=function(){this.keep_alive?this.keep_alive=!1:(this.clear_accept_timeout_event(),console.log("websocket accept_data_timeout "),this.close())},downloadVideo.prototype.clear_get_respond_timeout_event=function(){null!=this.get_response_timeout_event&&(clearTimeout(this.get_response_timeout_event),this.get_response_timeout_event=void 0)},downloadVideo.prototype.get_respond_timeout=function(){this.keep_process_data_time_out?this.keep_process_data=!1:this.keep_process_data_time_out=!0},downloadVideo.prototype.postMessage=function(e){self.postMessage(e)};var test=0;downloadVideo.prototype.parse_data=function(e){var t,o;this.keep_alive=!0,++this.recieve_count,null!=this.decoder&&(this.keep_process_data&&(o=new Uint8Array(e.data),this.decoder.decode_data(o)&&(o=void 0,t={status:1,y_data:this.decoder.get_y_data(),y_width:this.decoder.get_y_width(),y_height:this.decoder.get_y_height(),u_data:this.decoder.get_u_data(),u_width:this.decoder.get_u_width(),u_height:this.decoder.get_u_height(),v_data:this.decoder.get_v_data(),v_width:this.decoder.get_v_width(),v_height:this.decoder.get_v_height()},(e=[]).push(t.y_data.buffer),e.push(t.u_data.buffer),e.push(t.v_data.buffer),self.postMessage(t,e)),o=void 0),this.recieve_count>this.recieve_max_times&&(this.recieve_count=0,null!=this.ws&&(o=this.ws.readyState,WebSocket.OPEN==o&&this.ws.send("keep-alive"))))},downloadVideo.prototype.close=function(){if(null!=this.ws){var e,t=this.ws.readyState;WebSocket.OPEN==t&&(e=get_current_date(),console.log(" send stop to server "+this.deviceid+" time "+e),this.ws.send("stop")),this.recieve_count=0,this.clear_accept_timeout_event(),this.clear_connect_timeout_event(),this.clear_get_respond_timeout_event();try{WebSocket.OPEN!=t&&WebSocket.CONNECTING!=t||(e=get_current_date(),WebSocket.OPEN==t?console.log("ws.closed when WebSocket.OPEN == readyState "+this.deviceid+" time "+e):console.log("ws.closed when WebSocket.CONNECTING == readyState "+this.deviceid+" time "+e),this.ws.close())}catch(e){}this.ws=void 0}},downloadVideo.prototype.Suicide=function(){null!=this.decoder&&this.decoder.Suicide(),self.close()},self.downloadVideo=new downloadVideo,self.onmessage=function(e){if(self.downloadVideo){var t=self.downloadVideo;switch(e.data.status){case 0:t.return_status=0,self.downloadVideo.close();break;case 1:self.downloadVideo.initWebsocket(e.data,function(e){t.parse_data(e)});break;case 2:self.downloadVideo.Suicide();self.postMessage({status:2});break;case 4:self.downloadVideo.keep_process_data=!0,self.downloadVideo.keep_process_data_time_out=!1}}else console.log("[ER] Downloader not initialized!")};